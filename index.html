<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEA Disperse</title>
  <!-- Web3 dependency -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    :root {
      /* Background colors (60%) */
      --bg-1: #0A0711;
      --bg-2: #0A0711;
      --bg-3: #0E0D17;
      --bg-4: #11111C;
      --raisin-black: #1A1A2D;
      
      /* Neutral colors (30%) */
      --white: #FFFFFF;
      --periwinkle: #B9C5E5;
      --space-cadet: #4E5070;
      
      /* Accent colors (10%) */
      --light-green: #98FF99;
      --malachite: #25DE4E;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    body {
      background-color: var(--bg-1);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    nav {
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--bg-2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--light-green);
    }
    
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .connect-btn {
      background-color: transparent;
      border: 1px solid var(--light-green);
      color: var(--light-green);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .connect-btn:hover {
      background-color: rgba(152, 255, 153, 0.1); /* Light green with opacity */
      border-color: var(--light-green);
      color: var(--light-green);
    }
    
    .connected-btn {
      background-color: var(--raisin-black);
      color: var(--white);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      border: none; /* Remove border */
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer; /* Add pointer cursor */
    }
    
    .connected-btn:hover {
      background-color: rgba(78, 80, 112, 0.8); /* Slightly lighter than raisin-black */
    }
    
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .card {
      background-color: var(--bg-3);
      border-radius: 1rem;
      width: 100%;
      max-width: 480px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .instructions {
      margin-top: 2rem;
      padding: 1rem;
      background-color: var(--bg-4);
      border-radius: 0.5rem;
    }
    
    .instructions h3 {
      color: var(--light-green);
      margin-bottom: 1rem;
    }
    
    .instructions ol {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .instructions li {
      margin-bottom: 0.5rem;
      color: var(--periwinkle);
    }
    
    .example {
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--raisin-black);
      border-radius: 0.5rem;
    }
    
    .example h4 {
      color: var(--white);
      margin-bottom: 0.5rem;
    }
    
    .example p {
      margin-bottom: 0.25rem;
      color: var(--periwinkle);
    }
    
    .example pre {
      background-color: var(--bg-3);
      padding: 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
      color: var(--white);
      font-family: monospace;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    .input-group {
      background-color: var(--bg-4);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .input-group-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      color: var(--periwinkle);
      font-size: 0.875rem;
    }
    
    textarea {
      width: 100%;
      background-color: transparent;
      border: none;
      color: var(--white);
      font-size: 1rem;
      resize: none;
      padding: 0.5rem;
      outline: none;
    }
    
    textarea::placeholder {
      color: var(--space-cadet);
    }
    
    .action-btn {
      width: 100%;
      padding: 1rem;
      border-radius: 1rem;
      border: none;
      background-color: var(--light-green);
      color: var(--bg-1);
      font-weight: bold;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.2s;
    }
    
    .action-btn:hover:not(:disabled) {
      background-color: var(--malachite);
    }
    
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .wallet-display {
      text-align: center;
      margin-top: 1rem;
      color: var(--periwinkle);
      font-size: 0.875rem;
    }

    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
      display: none;
    }

    .status.success {
      background-color: rgba(37, 222, 78, 0.1);
      color: var(--light-green);
      border: 1px solid var(--malachite);
      display: block;
    }

    .status.error {
      background-color: rgba(255, 87, 87, 0.1);
      color: #FF5757;
      border: 1px solid #FF5757;
      display: block;
    }

    .status.loading {
      background-color: rgba(185, 197, 229, 0.1);
      color: var(--periwinkle);
      border: 1px solid var(--periwinkle);
      display: block;
    }
    
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .disconnect-btn {
      margin-top: 1rem;
      background-color: transparent;
      border: 1px solid var(--periwinkle);
      color: var(--periwinkle);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
      width: 100%;
      transition: all 0.2s;
    }
    
    .disconnect-btn:hover {
      background-color: rgba(255, 87, 87, 0.1);
      border-color: #FF5757;
      color: #FF5757;
    }
    
    .hidden {
      display: none !important;
    }
    
    .network-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      background-color: var(--raisin-black);
      color: var(--light-green);
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">
      <svg width="48" height="48" viewBox="0 0 181 181" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M67.0843 56.4376C72.8388 54.987 80.0116 55.3936 86.6103 60.8994C90.0762 63.7913 93.5955 64.0739 96.705 63.357C98.4229 62.9609 99.9068 62.2794 101.034 61.6127C102.149 60.9537 102.955 60.2852 103.297 59.8866C105.257 57.5997 108.7 57.3351 110.987 59.2956C113.274 61.256 113.539 64.6992 111.578 66.986C109.305 69.6378 104.675 72.7137 99.1556 73.9862C93.3342 75.3284 86.1569 74.7276 79.6219 69.2749C76.22 66.4364 72.8294 66.2387 69.7505 67.0148C66.4182 67.8548 63.6871 69.8266 62.7123 70.7692C60.5468 72.863 57.094 72.8049 55.0002 70.6394C52.9064 68.474 52.9645 65.0211 55.1299 62.9273C57.2214 60.9051 61.5865 57.8234 67.0843 56.4376Z" fill="#98FF99"/>
        <path d="M48.0384 47.9388C50.8486 49.0816 52.2297 52.2603 51.1231 55.0384C41.9289 78.1202 46.7466 103.763 60.3672 118.224C62.4476 120.433 62.3591 123.874 60.1696 125.91C57.9801 127.946 54.5186 127.806 52.4382 125.598C35.4684 107.58 30.4304 77.2997 40.9463 50.8997C42.0529 48.1216 45.2282 46.7959 48.0384 47.9388Z" fill="#98FF99"/>
        <path d="M118.55 47.9388C115.74 49.0816 114.359 52.2603 115.465 55.0384C124.659 78.1202 119.842 103.763 106.221 118.224C104.141 120.433 104.229 123.874 106.419 125.91C108.608 127.946 112.07 127.806 114.15 125.598C131.12 107.58 136.158 77.2997 125.642 50.8997C124.535 48.1216 121.36 46.7959 118.55 47.9388Z" fill="#98FF99"/>
        <path d="M67.5539 128.018C67.5539 125.005 69.9957 122.564 73.0079 122.564H93.223C96.2352 122.564 98.6771 125.005 98.6771 128.018C98.6771 131.03 96.2352 133.472 93.223 133.472H73.0079C69.9957 133.472 67.5539 131.03 67.5539 128.018Z" fill="#98FF99"/>
        <path d="M140.198 70.3205V69.9474C140.198 66.9352 142.64 64.4934 145.652 64.4934C148.664 64.4934 151.106 66.9352 151.106 69.9474V70.3205C151.106 73.3327 148.664 75.7745 145.652 75.7745C142.64 75.7745 140.198 73.3327 140.198 70.3205Z" fill="#98FF99"/>
        <path d="M140.233 93.1433C140.549 90.1478 143.233 87.9754 146.229 88.2913C149.224 88.6071 151.397 91.2916 151.081 94.2872C150.453 100.244 148.823 105.764 147.394 109.731C146.673 111.731 145.988 113.377 145.478 114.535C145.191 115.185 144.569 116.488 144.569 116.488C143.201 119.148 139.941 120.213 137.265 118.864C134.576 117.51 133.493 114.232 134.846 111.543L134.848 111.539C135.075 111.077 135.289 110.607 135.497 110.135C135.922 109.169 136.51 107.76 137.132 106.033C138.389 102.545 139.729 97.926 140.233 93.1433Z" fill="#98FF99"/>
    </svg>
      <span>TEA Disperse</span>
    </div>
    
    <button id="connectButton" class="connect-btn">Connect Wallet</button>
  </nav>
  
  <main>
    <div class="card">
      <div class="card-body">
        <div class="input-group">
          <div class="input-group-header">
            <span>Addresses</span>
          </div>
          <textarea id="addresses" rows="4" placeholder="0xabc... 0xdef..."></textarea>
        </div>
        
        <div class="input-group">
          <div class="input-group-header">
            <span>Amounts</span>
          </div>
          <textarea id="amounts" rows="4" placeholder="0.01 0.02"></textarea>
        </div>
        
        <button id="sendButton" class="action-btn" disabled>Disperse TEA</button>
        
        <div class="wallet-display" id="walletAddress">Not connected</div>
        
        <div id="status" class="status"></div>
        
        <button id="disconnectButton" class="disconnect-btn hidden">Disconnect Wallet</button>
        
        <div class="instructions">
          <h3>How to Disperse TEA</h3>
          <ol>
            <li>Connect your wallet using the "Connect Wallet" button at the top.</li>
            <li>Enter the recipient addresses in the "Addresses" field (one per line or space-separated).</li>
            <li>Enter the corresponding TEA amounts in the "Amounts" field (one per line or space-separated).</li>
            <li>Ensure each address has a corresponding amount in the same order.</li>
            <li>Click the "Disperse TEA" button to send the specified amounts to each address in a single transaction.</li>
          </ol>
          <div class="example">
            <h4>Example:</h4>
            <p>Addresses:</p>
            <pre>0x1234... 0x5678...</pre>
            <p>Amounts:</p>
            <pre>0.1 0.2</pre>
            <p>This will send 0.1 TEA to 0x1234... and 0.2 TEA to 0x5678...</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    let web3;
    let userAccount;
    let contract;
    const contractAddress = "0xD393a85Ae473a0a551F97631a093c427443f0C6c";
    const teaChainId = 10218; // Tea Sepolia chain ID
    
    // Replace this with your actual ABI
    const abi = [	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "recipients",
				"type": "address[]"
			},
			{
				"internalType": "uint256[]",
				"name": "amounts",
				"type": "uint256[]"
			}
		],
		"name": "disperseEther",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "totalAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "recipientCount",
				"type": "uint256"
			}
		],
		"name": "EtherDispersed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RefundSent",
		"type": "event"
	}
]; // YOUR_ABI_HERE
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("connectButton").addEventListener("click", connectWallet);
      document.getElementById("sendButton").addEventListener("click", disperse);
      document.getElementById("disconnectButton").addEventListener("click", disconnectWallet);
      
      // Check if MetaMask or other provider is already connected
      checkConnection();
    });
    
    // Check if wallet is already connected
    async function checkConnection() {
      if (window.ethereum) {
        try {
          // Create Web3 instance
          web3 = new Web3(window.ethereum);
          
          // Get accounts
          const accounts = await web3.eth.getAccounts();
          if (accounts.length > 0) {
            // Get chain ID
            const chainId = await web3.eth.getChainId();
            
            // Initialize and handle accounts
            await initializeWeb3WithAccounts(accounts, chainId);
          }
        } catch (error) {
          console.log("No pre-existing connection found");
        }
      }
    }
    
    // Connect wallet function
    async function connectWallet() {
      // Reset status
      setStatus('', '');
      
      // Check if MetaMask is installed
      if (!window.ethereum) {
        setStatus('Please install MetaMask or another Web3 wallet', 'error');
        return;
      }
      
      try {
        // Request account access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // Create Web3 instance
        web3 = new Web3(window.ethereum);
        
        // Get chain ID
        const chainId = await web3.eth.getChainId();
        
        // Initialize and handle accounts
        await initializeWeb3WithAccounts(accounts, chainId);
        
        // Set up event listeners
        setupProviderEvents();
        
      } catch (error) {
        console.error("Connection error:", error);
        setStatus(`Connection failed: ${error.message}`, 'error');
      }
    }
    
    // Initialize Web3 with accounts
    async function initializeWeb3WithAccounts(accounts, chainId) {
      // Handle accounts
      handleAccountsChanged(accounts);
      
      // Check if we're on the right network
      if (chainId !== teaChainId) {
        setStatus(`Please switch to TEA Network (Chain ID: ${teaChainId})`, 'error');
        
        // Try to switch network
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: `0x${teaChainId.toString(16)}` }]
          });
        } catch (switchError) {
          // This error code indicates that the chain has not been added to MetaMask
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: `0x${teaChainId.toString(16)}`,
                  chainName: 'Tea Sepolia',
                  nativeCurrency: {
                    name: 'TEA',
                    symbol: 'TEA',
                    decimals: 18
                  },
                  rpcUrls: ['https://tea-sepolia.g.alchemy.com/public'],
                  blockExplorerUrls: ['https://sepolia.tea.xyz']
                }]
              });
            } catch (addError) {
              console.error('Failed to add network:', addError);
            }
          }
        }
      } else {
        // Initialize contract if we're on the right network
        contract = new web3.eth.Contract(abi, contractAddress);
        setStatus('Connected successfully to TEA Network!', 'success');
      }
    }
    
    // Setup provider events
    function setupProviderEvents() {
      if (window.ethereum) {
        // Subscribe to accounts change
        window.ethereum.on("accountsChanged", handleAccountsChanged);
        
        // Subscribe to chainId change
        window.ethereum.on("chainChanged", () => {
          window.location.reload();
        });
        
        // Subscribe to disconnect
        window.ethereum.on("disconnect", () => {
          handleDisconnect();
        });
      }
    }
    
    // Handle account changes
    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        handleDisconnect();
        return;
      }
      
      userAccount = accounts[0];
      
      // Update UI
      document.getElementById("walletAddress").textContent = 
        `Connected: ${userAccount.substring(0, 6)}...${userAccount.substring(userAccount.length - 4)}`;
      
      // Update connect button
      const connectBtn = document.getElementById("connectButton");
      connectBtn.innerHTML = `${userAccount.substring(0, 6)}...<span class="network-badge">TEA</span>`;
      connectBtn.className = "connected-btn";
      
      // Show disconnect button
      document.getElementById("disconnectButton").classList.remove("hidden");
      
      // Enable send button
      document.getElementById("sendButton").disabled = false;
    }
    
    // Disconnect wallet function
    async function disconnectWallet() {
      handleDisconnect();
    }
    
    // Handle disconnection
    function handleDisconnect() {
      userAccount = null;
      web3 = null;
      contract = null;
      
      // Update UI
      document.getElementById("walletAddress").textContent = "Not connected";
      document.getElementById("sendButton").disabled = true;
      
      const connectBtn = document.getElementById("connectButton");
      connectBtn.textContent = "Connect Wallet";
      connectBtn.className = "connect-btn";
      
      // Hide disconnect button
      document.getElementById("disconnectButton").classList.add("hidden");
      
      setStatus('Wallet disconnected', 'pending');
      setTimeout(() => setStatus('', ''), 3000);
    }
    
    // Set status message
    function setStatus(message, type) {
      const statusElement = document.getElementById("status");
      statusElement.textContent = message;
      statusElement.className = "status";
      
      if (message) {
        statusElement.classList.add(type);
      }
    }
    
    // Parse input addresses and amounts
    function parseInputs() {
      // Get input values and normalize
      const addressesInput = document.getElementById("addresses").value.trim();
      const amountsInput = document.getElementById("amounts").value.trim();
      
      // Split by any whitespace (spaces, tabs, newlines)
      const addresses = addressesInput.split(/\s+/).filter(addr => addr !== '');
      const amountsStr = amountsInput.split(/\s+/).filter(amt => amt !== '');
      
      if (addresses.length === 0) {
        throw new Error("Please enter at least one address");
      }
      
      if (amountsStr.length === 0) {
        throw new Error("Please enter at least one amount");
      }
      
      if (addresses.length !== amountsStr.length) {
        throw new Error(`Number of addresses (${addresses.length}) doesn't match number of amounts (${amountsStr.length})`);
      }
      
      // Validate addresses
      for (const addr of addresses) {
        if (!web3.utils.isAddress(addr)) {
          throw new Error(`Invalid address format: ${addr}`);
        }
      }
      
      // Convert amounts to numbers and validate
      const amounts = [];
      for (let i = 0; i < amountsStr.length; i++) {
        const amount = Number(amountsStr[i]);
        if (isNaN(amount) || amount <= 0) {
          throw new Error(`Invalid amount at position ${i+1}: ${amountsStr[i]}`);
        }
        amounts.push(amount);
      }
      
      return { addresses, amounts };
    }
    
    // Disperse function
    async function disperse() {
      if (!userAccount || !web3 || !contract) {
        setStatus("Please connect your wallet first.", "error");
        return;
      }
      
      try {
        const { addresses, amounts } = parseInputs();
        setStatus("Preparing transaction...", "pending");
        
        // Convert TEA amounts to Wei
        const amountsWei = amounts.map(amount => web3.utils.toWei(amount.toString(), "ether"));
        const totalWei = amountsWei.reduce((a, b) => BigInt(a) + BigInt(b), 0n);
        
        // Display summary before sending
        const totalEth = web3.utils.fromWei(totalWei.toString(), "ether");
        setStatus(`Preparing to send ${totalEth} TEA to ${addresses.length} addresses. Waiting for wallet confirmation...`, "pending");
        
        // Request approval for the transaction
        const tx = await contract.methods.disperseEther(addresses, amountsWei).send({
          from: userAccount,
          value: totalWei.toString()
        });
        
        // Show success with transaction hash
        setStatus(`Transaction sent successfully! TX Hash: ${tx.transactionHash.substring(0, 10)}...`, "success");
        
      } catch (error) {
        console.error("Transaction error:", error);
        
        if (error.code === 4001) {
          setStatus("Transaction rejected by user.", "error");
        } else {
          setStatus(`Error: ${error.message}`, "error");
        }
      }
    }
  </script>
</body>
</html>
